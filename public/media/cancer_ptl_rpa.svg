<svg width="1280" height="800" viewBox="0 0 1280 800" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#071422"/>
      <stop offset="1" stop-color="#0B1F36"/>
    </linearGradient>
    <style>
      .box{fill:#0D2746; stroke:#9AD1FF; stroke-width:2; rx:18}
      .label{font:600 26px system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; fill:#F4FAFF}
      .sub{font:500 18px system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; fill:#C7E6FF}
      .arrow{stroke:#C7E6FF; stroke-width:3; marker-end:url(#arrowHead)}
      .code{fill:#0B1730; stroke:#5EA8FF; stroke-width:1.5; rx:16}
      .mono{font:500 16px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; fill:#CFE7FF}
      .kw{fill:#A6E1FA}
      .fn{fill:#79D2A5}
      .sym{fill:#FFD78A}
    </style>
    <marker id="arrowHead" viewBox="0 0 10 10" refX="8.5" refY="5" markerWidth="10" markerHeight="10" orient="auto-start-reverse">
      <path d="M0 0 L10 5 L0 10 Z" fill="#C7E6FF"/>
    </marker>

    <!-- ✅ Clip in local coords for the translated group -->
    <clipPath id="codeClip" clipPathUnits="userSpaceOnUse">
      <rect x="0" y="0" width="560" height="704" rx="16" ry="16"/>
    </clipPath>
  </defs>

  <rect width="1280" height="800" fill="url(#bg)"/>

  <!-- LEFT pipeline (unchanged) -->
  <g transform="translate(60,80)">
    <rect x="0" y="0" width="560" height="96" class="box"/>
    <g transform="translate(280,48)">
      <text class="label" text-anchor="middle" dominant-baseline="middle">Compute week &amp; create folder</text>
      <text class="sub" text-anchor="middle" dominant-baseline="middle" y="24">previous Sunday → YYYY.MM.DD</text>
    </g>
    <line x1="280" y1="96" x2="280" y2="136" class="arrow"/>

    <rect x="0" y="140" width="560" height="96" class="box"/>
    <g transform="translate(280,188)">
      <text class="label" text-anchor="middle" dominant-baseline="middle">Roll-forward &amp; rename artifacts</text>
      <text class="sub" text-anchor="middle" dominant-baseline="middle" y="24">copy main workbook • CANPTL V3 → “- {date}”</text>
    </g>
    <line x1="280" y1="236" x2="280" y2="276" class="arrow"/>

    <rect x="0" y="280" width="560" height="120" class="box"/>
    <g transform="translate(280,340)">
      <text class="label" text-anchor="middle" dominant-baseline="middle">Excel refresh (xlwings)</text>
      <text class="sub" text-anchor="middle" dominant-baseline="middle" y="24">visible app • RefreshAll ×2 • save &amp; close</text>
    </g>
    <line x1="280" y1="400" x2="280" y2="440" class="arrow"/>

    <rect x="0" y="444" width="560" height="120" class="box"/>
    <g transform="translate(280,504)">
      <text class="label" text-anchor="middle" dominant-baseline="middle">Render KPI HTML table</text>
      <text class="sub" text-anchor="middle" dominant-baseline="middle" y="24">Summary!A1:G6 → DataFrame → inline CSS</text>
    </g>
    <line x1="280" y1="564" x2="280" y2="604" class="arrow"/>

    <rect x="0" y="608" width="560" height="96" class="box"/>
    <g transform="translate(280,656)">
      <text class="label" text-anchor="middle" dominant-baseline="middle">Mail-merge template &amp; send</text>
      <text class="sub" text-anchor="middle" dominant-baseline="middle" y="24">insert [INSERT TABLE] • attach deliverables</text>
    </g>
  </g>

  <!-- RIGHT code panel: translated group uses local (0,0) clip -->
  <g transform="translate(660,80)">
    <rect x="0" y="0" width="560" height="704" class="code"/>
    <g class="mono" clip-path="url(#codeClip)">
      <text x="20" y="40"><tspan class="kw">import</tspan> os, shutil, datetime, time</text>
      <text x="20" y="64"><tspan class="kw">import</tspan> xlwings <tspan class="sym">as</tspan> xw, pandas <tspan class="sym">as</tspan> pd</text>
      <text x="20" y="88"><tspan class="kw">import</tspan> win32com.client <tspan class="sym">as</tspan> win32</text>

      <text x="20" y="124"><tspan class="kw">def</tspan> <tspan class="fn">get_previous_sunday</tspan>():</text>
      <text x="40" y="148">d = datetime.date.today()</text>
      <text x="40" y="172">return (d - datetime.timedelta(</text>
      <text x="40" y="196">  days=(d.weekday()+1)%7)).strftime(<tspan class="sym">'%Y.%m.%d'</tspan>)</text>

      <text x="20" y="232"><tspan class="kw">def</tspan> <tspan class="fn">open_excel_and_refresh</tspan>(path):</text>
      <text x="40" y="256">app = xw.App(visible=<tspan class="kw">True</tspan>)</text>
      <text x="40" y="280">wb  = app.books.open(path); time.sleep(30)</text>
      <text x="40" y="304">wb.api.RefreshAll(); time.sleep(15)</text>
      <text x="40" y="328">wb.api.RefreshAll(); wb.save(); wb.close()</text>
      <text x="40" y="352">app.quit()</text>

      <text x="20" y="388"><tspan class="kw">def</tspan> <tspan class="fn">generate_html_table</tspan>(df):</text>
      <text x="40" y="412"># Summary!A1:G6 → compact HTML (Calibri, borders)</text>
      <text x="40" y="436"><tspan class="kw">return</tspan> df.to_html(index=<tspan class="kw">False</tspan>, border=<tspan class="kw">0</tspan>)</text>

      <text x="20" y="472"><tspan class="kw">def</tspan> <tspan class="fn">send_email</tspan>(html, tmpl):</text>
      <text x="40" y="496">ol   = win32.Dispatch(<tspan class="sym">'Outlook.Application'</tspan>)</text>
      <text x="40" y="520">mail = ol.CreateItemFromTemplate(tmpl)</text>
      <text x="40" y="544">mail.HTMLBody = mail.HTMLBody.replace(</text>
      <text x="40" y="568">  <tspan class="sym">'[INSERT TABLE]'</tspan>, html)</text>
      <text x="40" y="592"># attach files (avoid raw CANPTL unless needed)</text>
      <text x="40" y="616">mail.Send()</text>
    </g>
  </g>
</svg>